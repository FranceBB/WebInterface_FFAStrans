<html>

	<head>
		<meta charset="UTF-8">

			<script src="../../dependencies/jquery/jquery.js"></script>
			
			<script src="/socket.io/socket.io.js"> </script>
			<script src="jsmpeg-master/jsmpeg.min.js"> </script>


			<link rel="stylesheet" type="text/css" href="../../dependencies/fontawesome/css/all.css"></link>

			<link rel="stylesheet" href="../../dependencies/dhtmlx/8.0.0/suite.css" type="text/css"/> 
			<script src="../../dependencies/dhtmlx/8.0.0/suite.umd.js"></script>
				<script src="../../dependencies/dhtmlx/dhtmlx.js"></script>
				<link rel="stylesheet" href="../../dependencies/dhtmlx/dhtmlx.css" id="theme_loader" type="text/css">
				<script>
					//theme changeer
					if (localStorage.global_skin_dark == "1"){
						window.setTimeout(function(){
							try{
								document.querySelector("#theme_loader").href = document.querySelector("#theme_loader").href.replace("dhtmlx.css","dhtmlx_benjamin.css")
							}catch(ex){}
							try{
								dhx.setTheme("dark");
							}catch(ex){}
							try{
								dhx8.dhx.setTheme("dark");
							}catch(ex){}
						},100)
						
					}
				</script>
			<style>
			html, body {
				width: 100%;
				height: 100%;
				margin: 0px;
				overflow: hidden;
				font-family: "Tahoma";
				font-size: 11px;
				--preview-display : "none";
			}
			input{
				font-size: 11px;
			}
			div.gridbox_dhx_skyblue.gridbox table.obj{
				font-size:11px;
			}

			.player-btns {
				display:inline-block;

			} 
			
			.noSelect {
				-webkit-tap-highlight-color: transparent;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}

			.noSelect:focus {
				outline: none !important;
			}

			
			.grayBackgroundOnHover:hover{
				font-size:2.9em;
			}

			.flexContainer{
				display: flex;
			}
			.flexFixed{
				width: 150px;
			}
			.flexGrow{
				flex-grow: 1;
			}

			.canvasContainer{
				width: calc(100vw - 150px) ;
				height: calc(100vh - 100px) ;
				background-color: black ;
				display: flex;
				align-items: center;
				justify-content: center;
				/*
				
    			aspect-ratio: 16 / 9 !important; */
			}

			.playerControls{
				position:static
			}
			.vertical-center{
				justify-content: center;
    			display: flex;
			}



			</style>
			
			<script>
var socket = io(); 
var player;
var g_framerate = 0;
reversePlayInterval = null;
var m_query_params = new URLSearchParams(window.location.search);

function load(){

			//now initialize the player stuff
			var buf = [];
		    player = new JSMpeg.Player(null,//null
				{
					source: JSMpegWritableSource,
					videoBufferSize: 1024*1024 * 10,
					audioBufferSize: 256*1024 * 10,
					disableWebAssembly:false,
					pauseWhenHidden:false,
					canvas:document.getElementById('playerCanvas'),
					loop: true, 
					autoplay: true, 
					onVideoDecode:function(what,time){
						//console.log("Videodecode",what,time)
					}
				});
				
			socket.emit("player", JSON.stringify({
                "file":m_query_params.get("file")
			})); 
			
			socket.on('ffprobe', function (data) {
					// player analyzes the file before starting vlc/ffmpeg
					// we use this initial analysis data for display file props on UI
					console.log("ffprobe",data);
					var firstVstream = getFirstTrack(data,"video");
					var _resolution = "0x0";
					g_framerate = 25;
					var _interlacing = "";

					if(firstVstream){
						g_framerate = eval(firstVstream["r_frame_rate"]);
						_resolution = firstVstream["width"] + "x" + firstVstream["height"] ;
						if (firstVstream["field_order"]){
							_interlacing = firstVstream["field_order"];
						}
					}

					document.getElementById("info-interlacing").innerHTML = "Interlaced: " + _interlacing || "";
					document.getElementById("info-fps").innerHTML = "FPS: " + parseFloat(g_framerate.toFixed(2)) || "";
					document.getElementById("info-res").innerHTML = _resolution || "";

					var num_audio_tracks = countTracks(data,"audio");
					document.getElementById("info-atracks").innerHTML = "Audios: " + num_audio_tracks || "";

					//construct select options for changing atrack
					var selectEle = document.getElementById("changeAudioTrack");
					if (selectEle.innerHTML == ""){
						for (var trackNum = 0;trackNum<num_audio_tracks;trackNum++){
							var myOption = document.createElement("option");
							myOption.text = trackNum + 1;
							myOption.value = trackNum;
							selectEle.add(myOption);
						}
					}	
			});

			socket.on('binarydata', function (data) {
				// pretend you are getting data as follows
					player.source.write(data,function(){});
					
			});
			socket.on('playererror', function (data) {
				// pretend you are getting data as follows
					dhtmlx.alert("Player Error: " + JSON.stringify(data))
					
			});

			socket.on('property-change', function (data) {
				// pretend you are getting data as follows
				var status = data;
				var _timecode = SMPTEToString(secondsToSMPTE(status["time-pos"],g_framerate))
				document.getElementById("currentTime").value = _timecode
				var _duration = SMPTEToString(secondsToSMPTE(status.duration,g_framerate))
				document.getElementById("totalTime").value = _duration
				document.getElementById("slider").setAttribute("max", status.duration)
				try{
					if (status.root.rate >= 1){
						document.getElementById("rate_display").innerHTML = Math.round(status.root.rate);					
					}else{
						var _rt = status.root.rate.toFixed(2);
						document.getElementById("rate_display").innerHTML = _rt;
					}
				}catch(ex){
				
				}
				if ($('#slider:hover').length == 0){
					//prevent slider update on hover
					var percentage = status["time-pos"];
					document.getElementById("slider").value = percentage;
				}
		
				$( "#iconPlay" ).toggleClass( "fa-play-circle ", status.pause );
				$( "#iconPlay" ).toggleClass( "fa-pause-circle ", !status.pause );
			});
			
			document.addEventListener("visibilitychange", function() {
				//if page is hidden, do not continue playing, otherwise jsmpeg just caches frames and when page is visible again, it tries to slow forward to now because pauseWhenHidden does not work for our usecase
				console.log(document.hidden, document.visibilityState);
				playPause();
			}, false);
			
			//EVENTS
			attachEvents()
}

function countTracks(ffprobe,type="audio"){
	var acount = 0;
	for (var i=0;i<ffprobe["streams"].length;i++){
		if (ffprobe["streams"][i]["codec_type"] == type){
			acount++;
		}
	}
	return acount;
}

function getFirstTrack(ffprobe,type="video"){
	for (var i=0;i<ffprobe["streams"].length;i++){
		if (ffprobe["streams"][i]["codec_type"] == type){
			return ffprobe["streams"][i];
		}
	}
	return false;
}


function attachEvents(){
			//slider
	document.getElementById("slider").addEventListener ('change', function (evt) {
		console.log("Slider change to ",document.getElementById("slider").value)
		playerCommandSeek(document.getElementById("slider").value );
		evt.cancelBubble = true;
		evt.preventDefault();
	});

	const playerCanvasResizeObserver = new ResizeObserver(entries => {
		//keep video aspect ration when resizing
		console.log(document.getElementById("canvasContainer").style.height);
		let containerHeight = entries[0].target.offsetHeight;//bottom controls always stay
		let containerWidth = entries[0].target.offsetWidth; //right side width always stays
		
		//check if height or width needs to be altered to match 16x9
		if (containerHeight * 16 / 9 > containerWidth){
			console.log("reducing canvas height to match width",containerWidth,containerWidth * 9 / 16)
			document.getElementById("playerCanvas").style.width 	= containerWidth;
			document.getElementById("playerCanvas").style.height 	= containerWidth * 9 / 16 ;
		}else{
			console.log("reducing canvas width to match height",containerHeight * 16 / 9,containerHeight)
			document.getElementById("playerCanvas").style.width 	= containerHeight * 16 / 9;
			document.getElementById("playerCanvas").style.height 	= containerHeight ;
		}
	});

	const md = document.getElementById("canvasContainer");
	playerCanvasResizeObserver.observe(md);

}

function playerChangeAtrackCommand(newTracknum){
	socket.emit("player", JSON.stringify({
                "command": "changeAtrack",
				"value" : newTracknum
			}));
}

function simplePlayerCommand(what){
	socket.emit("player", JSON.stringify({
                "command": what
			}));
}

function playerCommandSetRate(newRate){
	//simplePlayerCommand("pl_forceresume");
	socket.emit("player", JSON.stringify({
                "command": "rate",
                "val": encodeURIComponent(newRate)
			}));
}

function slower(){
	var maxspeed = 0.24;
	var currentRate = document.getElementById("rate_display").innerHTML;
	currentRate = parseFloat(currentRate);
	if (currentRate - 0.25 <= maxspeed){
		//cannot play reverse
		return;
	}
	try{
		currentRate = currentRate - 0.25;
		console.log("Setting rate to ", currentRate)
		playerCommandSetRate(currentRate);
		
	}catch(ex){
		dhtmlx.alert("Current Rate is not a number: " +currentRate);
	}
}

function faster(){
	var maxspeed = 32;
	var currentRate = document.getElementById("rate_display").innerHTML;
	currentRate = parseInt(currentRate);
	if (currentRate + 1  >= maxspeed){
	
		return;
	}
	try{
		currentRate = currentRate * 2;
		playerCommandSetRate(currentRate);
	}catch(ex){
		dhtmlx.alert("Current Rate is not a number: " +currentRate);
	}
}

function playerCommandSeek(where){

		//disable slider updates, otherwise seek only works sporadically

		socket.emit("player", JSON.stringify({
                "command": "seek",
                "val": where
            }));
		playPause();
		playPause();
		
		//playerCommand("pl_forceresume");
		//window.setTimeout(	function(){playerCommand("pl_forcepause")},300);
		
}

function playPause(){
	if (reversePlayInterval){
		window.clearInterval(reversePlayInterval);
	}
	playerCommandSetRate("1");
	socket.emit("player", JSON.stringify({
                "command": "play"
            }));
	
}

/** Convert seconds to SMPTE timecode JSON object, example input is html video.currentTime */
function secondsToSMPTE(seconds, framerate) {
    var f = Math.floor((seconds % 1)  * framerate);
    var s = Math.floor(seconds);
    var m = Math.floor(s / 60);
    var h = Math.floor(m / 60);
    m = m % 60;
    s = s % 60;
    return {h: h, m: m, s: s, f: f};
}

function setInPoint(){
	let where = document.getElementById("currentTime").value;
	document.getElementById("markIn").value = where;
}

function setOutPoint(){
	let where = document.getElementById("currentTime").value;
	document.getElementById("markOut").value = where;

}

function takeSegment(){
	let inpoint 	= document.getElementById("markIn").value;
	let outpoint 	= document.getElementById("markOut").value;
	if (outpoint < inpoint){
		dhx8.dhx.alert({
            header: "Error",
            text: "out < in",
            buttons: ["Ok"]
        })
	}
	if (!inpoint.match(/^\d\d:\d\d:\d\d$/) || !outpoint.match(/^\d\d:\d\d:\d\d$/)){
		dhtmlx.alert("Inpoint and Outpoint must be in format 00:00:00");
		return
	}
	let file = m_query_params.get("file");
	parent.window.addSegmentRow(file,inpoint,outpoint);
}

function takeFile(){

	let file = m_query_params.get("file");
	parent.window.addFileRow(file);
}

/** Pretty print SMPTE timecode JSON object */
function SMPTEToString(timecode) {
    if (timecode.h < 10) { timecode.h = "0" + timecode.h; }
    if (timecode.m < 10) { timecode.m = "0" + timecode.m; }
    if (timecode.s < 10) { timecode.s = "0" + timecode.s; }
    if (timecode.f < 10) { timecode.f = "0" + timecode.f; }
	
    return timecode.h + ":" + timecode.m + ":" + timecode.s + ":" + timecode.f;// + ":" + timecode.f;
}

function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

function changeAudioTrack(option){
	
	dhtmlx.confirm({
		
		type:"confirm",
		text: "Changing Audio track causes reloading the clip.",
		callback: function(result){
			console.log("result",result)
			if (result)
				playerChangeAtrackCommand(option.value);
		}
	});
	
}


</script>

		</head>
		<body onload="load()">
			<div id="maindiv" style="width: 100%; overflow: hidden;" class="flexContainer">
				<div style="float:left" id="video_and_controls" class="flexGrow">
						
						<div id="canvasContainer" class="canvasContainer">
							<canvas id="playerCanvas"  class="playerCanvas"></canvas>
						</div>
						<div id="playerControls" class="playerControls">
							<div id="seekContainer" style="margin-top:5px">
								<table style="width:100%;font-size:11px">
									<tr>
										<td>
											<div style="float:left">Position: <input style="width:67px" id="currentTime"  value='00:00:00'/></div>
										</td>
										<td>
											<div style="width: 100%;text-align: center;">Rate: <div id="rate_display" style="display:inline">1</div><div style="display:inline">x</div></div>
										</td>
										<td>
											<div style="float:right">Duration: <input style="width:67px" id="totalTime" style="float:right" class="" value="00:00:00" style="display:flex;float:right"/></div>
										</td>
									</tr>
								</table>
								
								
								
								<div class="slidecontainer">
									<input type="range" id="slider" style="width:100%" min="0" max="100" value="0" class="slider" onchange="">
								</div>
							</div>
							<div id="controlButtons" class="vertical-center noSelect">
								<div class="player-btns">
									<i style="margin:3px;text-shadow:-2px 2px rgb(0 0 0 / 15%);cursor:pointer" title="-10s" id="iconStepMinus" 	class="fas fa-step-backward 		fa-3x grayBackgroundOnHover" onclick="playerCommandSeek('-10s')"></i>
									<i style="margin:3px;text-shadow:-2px 2px rgb(0 0 0 / 15%);cursor:pointer" title="slower" id="iconSlow" 		class="fas fa-backward 				fa-3x grayBackgroundOnHover" onclick="slower()"></i>
									<i style="margin:3px;text-shadow:-2px 2px rgb(0 0 0 / 15%);cursor:pointer" title="play/pause" id="iconPlay" 	class="fas fa-play-circle 			fa-3x grayBackgroundOnHover" onclick="playPause()"></i>
									<i style="margin:3px;text-shadow:-2px 2px rgb(0 0 0 / 15%);cursor:pointer" title="faster" id="iconFaste" 		class="fas fa-forward 				fa-3x grayBackgroundOnHover" onclick="faster()"></i>
									<i style="margin:3px;text-shadow:-2px 2px rgb(0 0 0 / 15%);cursor:pointer" title="+10s" id="iconStepPlus" 		class="fas fa-step-forward 	 		fa-3x grayBackgroundOnHover" onclick="playerCommandSeek('+10s')"></i>
								</div>
							<!-- </div> -->

							</div>

						</div>
					

				</div>

			<!--right side-->
			<div style="margin-left: 10px;margin:5px;width:150px" id="rightSide" class="flexFixed">
				<div style="" class="gridbox_dhx_skyblue gridbox">
					<table cellpadding="0" cellspacing="0" class="obj row20px" style="width: 100%; table-layout: fixed;">
						<tbody>
							<tr class=" odd_dhx_skyblue">
								<td align="left" valign="middle" id="info-res"></td>
							</tr>
							<tr class=" ev_dhx_skyblue">
								<td align="left" valign="middle" id="info-fps"></td>
							</tr>
							<tr class=" odd_dhx_skyblue">
								<td align="left" valign="middle" id="info-interlacing"></td>
							</tr>
							<tr class=" ev_dhx_skyblue">
								<td align="left" valign="middle" id="info-atracks"></td>
							</tr>
							<tr class=" odd_dhx_skyblue">
								<td align="left" valign="middle">
									Select Track: <select style="max-width:60px" id="changeAudioTrack" onchange="changeAudioTrack(this)" name="changeAudioTrack"></select>	  
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div style="height:20px"></div>
				<div id="markInOutButtons" class="gridbox_dhx_skyblue gridbox" style="padding:5px;">
					<span style="margin-bottom:5px" class="player_text_segment">Segment</span><br/>
					<table style="font-size:12px">
						<tr>
							<td><input type="submit" onclick="setInPoint()" style="font-size:10px;width:30px;height: 20px" value="In"></input></td><td>
								<input style="width:70px" id="markIn" ></input></td>
						</tr>
						<tr>
							<td><input type="submit" onclick="setOutPoint()" style="font-size:10px;width:30px;height: 20px" value="Out"></input></td><td>
								<input style="width:70px" id="markOut" ></input></td>
						</tr>
					 
					
					</table>
					<input type="submit" value="Take Segment" onclick="takeSegment()" style="margin-top:5px;height: 20px;margin-left:27px;font-size:10px"></input>
				
				</div>
				<input type="submit" value="Take File" onclick="takeFile()" style="position:absolute;bottom:2;;height: 20px;right:4;margin:5px"></input>
				<!-- <div style="height:10%;position:relative;">
					<input style="width:100%;height:100%"  type="submit" value="Add to List >>"></input>
				</div> -->
			</div>
		</div>
			</body>
		</html>