<html>
<head>
<link rel="stylesheet" href="/alternate-server/css/override.css"/>
<link rel="stylesheet" href="../../dependencies/dhtmlx/8.0.0/suite.css" type="text/css"/> 
<script src="../../dependencies/dhtmlx/8.0.0/suite.js"></script>
<link rel="stylesheet" href="../../dependencies/dhtmlx/dhtmlx.css" id="theme_loader" type="text/css">
<script>
    //theme changeer
    if (localStorage.global_skin_dark == "1"){
        try{
            document.querySelector("#theme_loader").href = document.querySelector("#theme_loader").href.replace("dhtmlx.css","dhtmlx_benjamin.css")
        }catch(ex){}
        try{
            dhx.setTheme("dark");
        }catch(ex){}
        try{
            dhx8.dhx.setTheme("dark");
        }catch(ex){}
    }
</script>

<script src="../../dependencies/jquery/jquery.js"></script>
<style>


</style>
<script>
var m_maingrid;
var m_last_data= null;
var m_alertmsg;

async function loadBrowseLocations(){
    var locations = await  $.ajax({
        url:  ("/browselocations"),
        type: "GET"
    });
    return locations;
}

async function saveBrowseLocations(data){
    try{
        var result = await  $.ajax({
            url:  ("/browselocations"),
            type: "POST",
            contentType: "application/json",
            data:JSON.stringify(data)
        });
        dhx.message({
                text:"Saved", 
                css:"expire", 
                expire:2000
            });
    }catch(ex){
        alert("Unexpected error saving, contact developer and send server logs");
    }
}

function init(){
    buildLayout();
}

function buildLayout(){
    //LAYOUT
    const layout_config = {
        //type: "wide",//"line" | "wide" | "space" | "none";
		width:"100%", height:"100%",rows:
		[   { id: "toolbar", height: "content" },
			{
				cols: [
                    
					{
                        header:"Browse Locations for Job Submitter (doubleclick to edit)",
						id: "main",
						resizable:false,
						padding: "0px",  
						margin: "0px",
					}]
			}
		]
	}
        
    var layout = new dhx.Layout("layout", layout_config);

    //GRID
    m_maingrid = new dhx.Grid("grid", {
        columns: [
            {  id: "displayname",   header: [{ text: "Display Name" }] },
            {  id: "path",          header: [{ text: "Path" }],   },
          
        ],
        editable: true,
        autoWidth: true,
        resizable: true,//allow manual resize
        selection:"row",
        
    });
    //TOOLBAR
    const cfg = [
        {
            id: "btnsave",
            type: "button",
            value: "Save",
            icon: "dxi dxi-content-save",
            size: "small",
            color: "secondary",
            css:"dhxform_obj_dhx_skyblue"
        },
        {
        type:"separator"
        },
        {
            id: "btadd",
            type: "button",
            value: "Add New",
            icon: "dxi dxi-plus",
            size: "small",
            color: "secondary",
            css:"dhxform_obj_dhx_skyblue"
        },{
            id: "btndel",
            type: "button",
            value: "Delete",
            icon: "dxi dxi-close",
            size: "small",
            color: "secondary",
            css:"dhxform_obj_dhx_skyblue"
        }
    
    ]
    const toolbar = new dhx.Toolbar(null, {
        css:"dhx_widget--bordered"
        });
    toolbar.data.add(cfg);
    toolbar.events.on("click", function(id,e){
        if(id == "btadd")
            addNewEntry()
        if(id == "btndel")
            deleteSelected()
        if(id == "btnsave")
            saveGridData()
    });
    layout.getCell("main").attach(m_maingrid);
    layout.getCell("toolbar").attach(toolbar);
    loadGridData();
    
}

window.setInterval(function(){
    /*display alert msg for unsaved changes*/
    let gridrows = m_maingrid.data.serialize();
    var got_changes = false;
    gridrows.forEach(function (row){
        //compare path and displayname, displayname must be unique
        var existingEntry = (m_last_data.filter(entry => entry.displayname == row.displayname))
        if (existingEntry.length != 1){
            got_changes = true;
        }
        if (existingEntry[0].path != row.path){
            got_changes = true;
        }
        console.log(row, "match",existingEntry[0])
    })
    
    if (got_changes){
        if (m_alertmsg)
            return;
        m_alertmsg = dhx.message({
                text:"Unsaved changes",
                css:"dhx_message--error",
                icon:"dxi-close",
                expire:1000000
            });
    }else{
        if (m_alertmsg){
            m_alertmsg.close();
            m_alertmsg = null;
        }
    }

},1000)

async function saveGridData(){
    const state = m_maingrid.data.serialize();
    console.log("gridstate",state);
    
    await saveBrowseLocations(state);
    m_last_data = JSON.parse(JSON.stringify(state));
}

async function loadGridData(){
    var locations = await(loadBrowseLocations());
    var gridData = [];
    Object.keys(locations).forEach(function(displayname) {
            var path = locations[displayname];
            gridData.push(
                {path:path,displayname:displayname}
            ) 
        });
    
    console.log("loading",gridData)
    m_last_data = JSON.parse(JSON.stringify(gridData));
    m_maingrid.data.parse(gridData);
}

function deleteSelected(){
    const selectedCells = m_maingrid.selection.getCells();
    if (selectedCells.length == 0){
        return;
    }
    m_maingrid.data.remove(selectedCells[0].row.id);
}

function addNewEntry(){
    //bring up form and post result to server
    var row = m_maingrid.data.add({path:"D:\\Example Location 123",displayname:"New Location"});
    m_maingrid.selection.setCell(row);
    return;

}

</script>
</head>
<body onload="init()">

</body>
</html>